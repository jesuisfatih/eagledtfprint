<!-- Eagle B2B - Optimized SSO Integration -->
<!-- Ultra-fast, seamless authentication -->
<!-- Add to theme.liquid before </body> -->

<!-- 
  CONFIGURATION: Add these settings to your Shopify theme:
  1. Go to Online Store > Themes > Customize > Theme Settings
  2. Add "Eagle API URL" and "Eagle Accounts URL" settings
  Or configure them below:
-->

<script>
(function() {
  'use strict';
  
  // Configuration: Use Shopify metafields or theme settings for multi-tenant support
  // Format: {{ shop.metafields.eagle.api_url | default: settings.eagle_api_url | default: 'https://api.eagledtfsupply.com' }}
  const EAGLE_API = '{{ shop.metafields.eagle.api_url | default: 'https://api.eagledtfsupply.com' }}';
  const EAGLE_ACCOUNTS = '{{ shop.metafields.eagle.accounts_url | default: 'https://accounts.eagledtfsupply.com' }}';
  
  // Shopify customer data
  const customer = {{ customer | json }};
  
  /**
   * Silent Authentication - No page reload, no user interruption
   */
  async function silentAuth() {
    try {
      if (customer && customer.id) {
        // Shopify → Eagle (Silent)
        const eagleToken = localStorage.getItem('eagle_token');
        
        if (!eagleToken) {
          // Background authentication via hidden iframe
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = `${EAGLE_API}/api/v1/auth/shopify-callback?customer_id=${customer.id}&email=${encodeURIComponent(customer.email)}`;
          document.body.appendChild(iframe);
          
          // Wait for auth response
          window.addEventListener('message', (event) => {
            if (event.origin === EAGLE_API && event.data.type === 'eagle_auth_success') {
              localStorage.setItem('eagle_token', event.data.token);
              localStorage.setItem('eagle_userId', event.data.userId);
              document.body.removeChild(iframe);
              console.log('✅ Eagle SSO: Silent login successful');
            }
          });
        }
      } else {
        // Eagle → Shopify (Silent)
        const eagleToken = localStorage.getItem('eagle_token');
        
        if (eagleToken && !customer) {
          // Get Shopify SSO URL
          fetch(`${EAGLE_API}/api/v1/auth/shopify-sso`, {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + eagleToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              returnTo: window.location.pathname
            })
          })
          .then(r => r.json())
          .then(data => {
            if (data.ssoUrl) {
              // Silent Shopify login via hidden iframe
              const iframe = document.createElement('iframe');
              iframe.style.display = 'none';
              iframe.src = data.ssoUrl;
              document.body.appendChild(iframe);
              
              // Reload after 1 second to see logged in state
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            }
          })
          .catch(err => console.error('Shopify SSO failed:', err));
        }
      }
    } catch (error) {
      console.error('Silent auth error:', error);
    }
  }

  /**
   * Cart Sync - Real-time
   */
  function syncCart() {
    if (!customer || !customer.email) return;
    
    let cartSyncTimeout;
    
    // Debounced cart sync (2 seconds after last change)
    function scheduleSync() {
      clearTimeout(cartSyncTimeout);
      cartSyncTimeout = setTimeout(async () => {
        try {
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          
          if (cart.items && cart.items.length > 0) {
            // Send to Eagle
            await fetch(`${EAGLE_API}/api/v1/abandoned-carts/track`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                customerEmail: customer.email,
                shopifyCustomerId: customer.id.toString(),
                cartToken: cart.token,
                items: cart.items.map(item => ({
                  productId: item.product_id,
                  variantId: item.variant_id,
                  quantity: item.quantity,
                  price: item.price / 100,
                  title: item.title
                })),
                totalPrice: cart.total_price / 100,
                currency: cart.currency,
                updatedAt: new Date().toISOString()
              })
            });
          }
        } catch (err) {
          console.error('Cart sync error:', err);
        }
      }, 2000);
    }

    // Watch cart changes
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      const result = originalFetch.apply(this, args);
      
      if (args[0] && args[0].toString().includes('/cart')) {
        scheduleSync();
      }
      
      return result;
    };

    // Initial sync
    scheduleSync();
  }

  /**
   * Session Persistence
   */
  function maintainSession() {
    // Check session every 5 minutes
    setInterval(() => {
      const eagleToken = localStorage.getItem('eagle_token');
      if (eagleToken) {
        // Ping to keep session alive
        fetch(`${EAGLE_API}/api/v1/auth/ping`, {
          headers: { 'Authorization': 'Bearer ' + eagleToken }
        }).catch(() => {});
      }
    }, 5 * 60 * 1000);
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      silentAuth();
      syncCart();
      maintainSession();
    });
  } else {
    silentAuth();
    syncCart();
    maintainSession();
  }
})();
</script>

